<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trino NL2SQL - Natural Language Query Interface</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üîç Trino NL2SQL</h1>
            <p>Ask questions in plain English, get SQL results</p>
        </header>

        <div class="chat-controls">
            <div class="conversation-meta">
                <div class="label">Conversation</div>
                <code id="conversation-id">‚Äî</code>
                <span id="storage-badge" class="storage-badge">memory</span>
            </div>
            <div class="control-buttons">
                <button id="schema-button" onclick="showSchema()">View Schema</button>
                <button id="new-chat-button" onclick="startNewConversation()">New Chat</button>
            </div>
        </div>

        <div class="chat-layout">
            <div class="chat-window">
                <div id="chat-messages" class="chat-messages"></div>
            </div>
            <div class="composer">
                <textarea
                    id="question-input"
                    placeholder="Ask a question about your data (e.g., 'Top 10 customers by revenue last quarter')..."
                    rows="3"
                ></textarea>
                <div class="composer-actions">
                    <div id="loading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <span>Thinking, generating SQL, and querying...</span>
                    </div>
                    <div class="composer-buttons">
                        <button id="submit-button" onclick="submitQuery()">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="schema-container" class="schema-container" style="display: none;">
            <h3>üìö Database Schema</h3>
            <button onclick="hideSchema()" class="close-button">Close</button>
            <pre id="schema-content" class="schema-content"></pre>
        </div>
    </div>

    <script>
        let conversationId = null;
        let storageBackend = 'memory';
        let messages = [];
        let pendingUserMessageId = null;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('question-input').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submitQuery();
                }
            });
            startNewConversation();
        });

        function renderMessages() {
            const container = document.getElementById('chat-messages');
            container.innerHTML = '';
            messages.forEach((msg, idx) => {
                const wrapper = document.createElement('div');
                wrapper.className = `message ${msg.role}`;

                const bubble = document.createElement('div');
                bubble.className = 'bubble';

                const content = document.createElement('div');
                content.className = 'text';
                content.textContent = msg.text;
                bubble.appendChild(content);

                if (msg.intent === 'chitchat') {
                    bubble.classList.add('chitchat');
                }

                if (msg.intent === 'clarification_needed') {
                    bubble.classList.add('clarification');
                }

                if (msg.sql || msg.table || (msg.steps && msg.steps.length)) {
                    const details = document.createElement('details');
                    const summary = document.createElement('summary');
                    summary.textContent = 'Show SQL & results';
                    details.appendChild(summary);

                    const meta = document.createElement('div');
                    meta.className = 'meta-block';
                    meta.innerHTML = `
                        ${msg.plan_type ? `<div class="pill">plan: ${msg.plan_type}</div>` : ''}
                        ${typeof msg.row_count === 'number' ? `<div class="pill">rows: ${msg.row_count}</div>` : ''}
                    `;
                    details.appendChild(meta);

                    if (msg.sql) {
                        const sqlBlock = document.createElement('pre');
                        sqlBlock.className = 'sql-code';
                        sqlBlock.textContent = msg.sql;
                        details.appendChild(sqlBlock);
                    }

                    if (msg.steps && msg.steps.length) {
                        msg.steps.forEach(step => {
                            const stepDiv = document.createElement('div');
                            stepDiv.className = 'step-block';
                            stepDiv.innerHTML = `
                                <div class="step-header"><strong>${step.id}</strong> ‚Äî ${step.objective || ''}</div>
                                ${step.sql ? `<pre class="sql-code">${step.sql}</pre>` : ''}
                                ${step.table ? `<div class="data-table">${step.table}</div>` : ''}
                            `;
                            details.appendChild(stepDiv);
                        });
                    } else if (msg.table) {
                        const tableDiv = document.createElement('div');
                        tableDiv.className = 'data-table';
                        tableDiv.innerHTML = msg.table;
                        details.appendChild(tableDiv);
                    }

                    bubble.appendChild(details);
                }

                wrapper.appendChild(bubble);
                container.appendChild(wrapper);
            });
            container.scrollTop = container.scrollHeight;
        }

        function appendMessage(message) {
            messages.push(message);
            renderMessages();
        }

        async function startNewConversation(topic = null) {
            try {
                const response = await fetch('/conversations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic })
                });
                const data = await response.json();
                if (data.status !== 'success') {
                    throw new Error(data.error || 'Unable to start a new chat');
                }
                conversationId = data.conversation_id;
                storageBackend = data.storage || 'memory';
                messages = [];
                renderMessages();
                updateConversationMeta();
                document.getElementById('question-input').value = '';
            } catch (error) {
                appendMessage({
                    role: 'assistant',
                    text: `Failed to create new chat: ${error.message}`,
                });
            }
        }

        async function ensureConversation() {
            if (conversationId) return conversationId;
            await startNewConversation();
            return conversationId;
        }

        async function submitQuery() {
            const input = document.getElementById('question-input');
            const question = input.value.trim();

            if (!question) {
                alert('Please enter a question');
                return;
            }

            await ensureConversation();

            const userMessage = { role: 'user', text: question };
            appendMessage(userMessage);
            input.value = '';

            document.getElementById('loading').style.display = 'flex';
            document.getElementById('submit-button').disabled = true;

            fetch('/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: question,
                    conversation_id: conversationId
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('submit-button').disabled = false;

                if (data.conversation_id) {
                    conversationId = data.conversation_id;
                    updateConversationMeta();
                }

                if (data.status === 'success') {
                    handleAssistantResponse(data);
                } else {
                    appendMessage({
                        role: 'assistant',
                        text: data.error || 'An unknown error occurred',
                        sql: data.sql || '',
                        intent: 'error',
                    });
                }
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('submit-button').disabled = false;
                appendMessage({
                    role: 'assistant',
                    text: error.message,
                    intent: 'error',
                });
            });
        }

        function handleAssistantResponse(data) {
            // multi-query path
            if (data.plan_type === 'multi_query' && Array.isArray(data.steps)) {
                const steps = data.steps.map(step => ({
                    id: step.step || step.id || '',
                    objective: step.objective || '',
                    sql: step.sql || '',
                    table: step.table || '',
                }));
                appendMessage({
                    role: 'assistant',
                    text: data.question || 'Multi-step plan executed.',
                    plan_type: 'multi_query',
                    steps,
                });
                return;
            }

            appendMessage({
                role: 'assistant',
                text: data.explanation || data.error || 'Done.',
                sql: data.sql || '',
                table: data.table || '',
                plan_type: data.plan_type || 'single',
                row_count: data.row_count,
                intent: data.intent,
            });
        }

        function showSchema() {
            document.getElementById('schema-container').style.display = 'block';
            if (!document.getElementById('schema-content').textContent) {
                fetch('/schema')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            document.getElementById('schema-content').textContent = data.schema;
                        } else {
                            document.getElementById('schema-content').textContent = 'Error loading schema: ' + data.error;
                        }
                    })
                    .catch(error => {
                        document.getElementById('schema-content').textContent = 'Error: ' + error.message;
                    });
            }
        }

        function hideSchema() {
            document.getElementById('schema-container').style.display = 'none';
        }

        function updateConversationMeta() {
            document.getElementById('conversation-id').textContent = conversationId || '‚Äî';
            document.getElementById('storage-badge').textContent = storageBackend || 'memory';
        }
    </script>
</body>
</html>
