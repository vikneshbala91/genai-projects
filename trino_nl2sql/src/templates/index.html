<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trino NL2SQL - Natural Language Query Interface</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üîç Trino NL2SQL</h1>
            <p>Ask questions in plain English, get SQL results</p>
        </header>

        <div class="chat-controls">
            <div class="conversation-meta">
                <div class="label">Conversation</div>
                <code id="conversation-id">‚Äî</code>
                <span id="storage-badge" class="storage-badge">memory</span>
            </div>
            <button id="new-chat-button" onclick="startNewConversation()">New Chat</button>
        </div>

        <div class="main-content">
            <div class="query-section">
                <div class="input-area">
                    <textarea
                        id="question-input"
                        placeholder="Ask a question about your data (e.g., 'Show me the top 10 customers by revenue')..."
                        rows="3"
                    ></textarea>
                    <button id="submit-button" onclick="submitQuery()">Ask Question</button>
                    <button id="schema-button" onclick="showSchema()">View Schema</button>
                </div>

                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <span>Generating SQL and querying database...</span>
                </div>
            </div>

            <div id="results-container" class="results-container" style="display: none;">
                <div class="result-section">
                    <h3>üìä Results</h3>
                    <div id="explanation" class="explanation"></div>
                </div>

                <div class="result-section">
                    <h3>üìù Generated SQL</h3>
                    <pre id="sql-query" class="sql-code"></pre>
                </div>

                <div class="result-section">
                    <h3>üìã Data Table</h3>
                    <div id="data-table" class="data-table"></div>
                </div>
            </div>

            <div id="error-container" class="error-container" style="display: none;">
                <h3>‚ùå Error</h3>
                <div id="error-message" class="error-message"></div>
                <pre id="error-sql" class="sql-code" style="display: none;"></pre>
            </div>

            <div id="schema-container" class="schema-container" style="display: none;">
                <h3>üìö Database Schema</h3>
                <button onclick="hideSchema()" class="close-button">Close</button>
                <pre id="schema-content" class="schema-content"></pre>
            </div>
        </div>

        <div class="examples">
            <h4>üí° Example Questions:</h4>
            <div class="example-buttons">
                <button onclick="setQuestion('Show me all customers')">Show all customers</button>
                <button onclick="setQuestion('How many orders were placed last month?')">Orders last month</button>
                <button onclick="setQuestion('What are the top 5 products by price?')">Top 5 products</button>
                <button onclick="setQuestion('Show total revenue by category')">Revenue by category</button>
            </div>
        </div>
    </div>

    <script>
        let conversationId = null;
        let storageBackend = 'memory';

        document.addEventListener('DOMContentLoaded', () => {
            // Submit query on Enter (Shift+Enter for new line)
            document.getElementById('question-input').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submitQuery();
                }
            });

            startNewConversation();
        });

        async function startNewConversation(topic = null) {
            try {
                const response = await fetch('/conversations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic })
                });

                const data = await response.json();

                if (data.status !== 'success') {
                    throw new Error(data.error || 'Unable to start a new chat');
                }

                conversationId = data.conversation_id;
                storageBackend = data.storage || 'memory';
                resetUiForNewChat();
                updateConversationMeta();
            } catch (error) {
                displayError({ error: `Failed to create new chat: ${error.message}` });
            }
        }

        async function ensureConversation() {
            if (conversationId) return conversationId;
            await startNewConversation();
            return conversationId;
        }

        function setQuestion(text) {
            document.getElementById('question-input').value = text;
        }

        async function submitQuery() {
            const input = document.getElementById('question-input');
            const question = input.value.trim();

            if (!question) {
                alert('Please enter a question');
                return;
            }

            await ensureConversation();

            // Hide previous results/errors
            document.getElementById('results-container').style.display = 'none';
            document.getElementById('error-container').style.display = 'none';
            document.getElementById('schema-container').style.display = 'none';

            // Show loading
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('submit-button').disabled = true;

            // Submit query
            fetch('/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: question,
                    conversation_id: conversationId
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('submit-button').disabled = false;

                if (data.status === 'success') {
                    displayResults(data);
                } else {
                    displayError(data);
                }
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('submit-button').disabled = false;
                displayError({ error: error.message });
            });
        }

        function displayResults(data) {
            if (data.conversation_id) {
                conversationId = data.conversation_id;
                updateConversationMeta();
            }

            document.getElementById('explanation').textContent = data.explanation;
            document.getElementById('sql-query').textContent = data.sql;
            document.getElementById('data-table').innerHTML = data.table;
            document.getElementById('results-container').style.display = 'block';
        }

        function displayError(data) {
            if (data.conversation_id) {
                conversationId = data.conversation_id;
                updateConversationMeta();
            }

            document.getElementById('error-message').textContent = data.error || 'An unknown error occurred';

            if (data.sql) {
                document.getElementById('error-sql').textContent = data.sql;
                document.getElementById('error-sql').style.display = 'block';
            } else {
                document.getElementById('error-sql').style.display = 'none';
            }

            document.getElementById('error-container').style.display = 'block';
        }

        function showSchema() {
            document.getElementById('schema-container').style.display = 'block';

            if (!document.getElementById('schema-content').textContent) {
                fetch('/schema')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            document.getElementById('schema-content').textContent = data.schema;
                        } else {
                            document.getElementById('schema-content').textContent = 'Error loading schema: ' + data.error;
                        }
                    })
                    .catch(error => {
                        document.getElementById('schema-content').textContent = 'Error: ' + error.message;
                    });
            }
        }

        function hideSchema() {
            document.getElementById('schema-container').style.display = 'none';
        }

        function updateConversationMeta() {
            document.getElementById('conversation-id').textContent = conversationId || '‚Äî';
            document.getElementById('storage-badge').textContent = storageBackend || 'memory';
        }

        function resetUiForNewChat() {
            document.getElementById('question-input').value = '';
            document.getElementById('results-container').style.display = 'none';
            document.getElementById('error-container').style.display = 'none';
            document.getElementById('schema-container').style.display = 'none';
        }
    </script>
</body>
</html>
